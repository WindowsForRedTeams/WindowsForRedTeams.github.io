<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to C2 Frameworks and Operations Security - Windows Offensive Techniques for Authorized Red Teams</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/mdbook-admonish.css">
        <link rel="stylesheet" href="src/custom.css">
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Windows Offensive Techniques for Authorized Red Teams</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction-to-c2-frameworks-and-operations-security"><a class="header" href="#introduction-to-c2-frameworks-and-operations-security">Introduction to C2 Frameworks and Operations Security</a></h1>
<p>Established Red Teams typically have documented procedures, toolsets, and frameworks to run repeatable engagements. <strong>Command &amp; Control</strong> Frameworks provide centralized orchestration. Operation leaders can assign roles, distribute tasks and resources, collect telemetry, and enforce OPSEC and governance controls across the team. In this section, we will review the general structure of C2 Frameworks and establish the foundational properties of operational security in red teaming engagements.</p>
<h2 id="command-and-control-frameworks"><a class="header" href="#command-and-control-frameworks">Command and Control Frameworks</a></h2>
<p>A <strong>Command and Control</strong> (C2) Framework is a tool that allows red teams and threat actors to communicate with and control compromised systems. They are used to send commands to target systems, receive data from these systems, and manage the system's operations. They provide a stealthy communication channel between an infected host and the attackers server. C2 Frameworks use a client-server model, where the attacker controls a control server to manage multiple infected systems. Once malware infects a device, it connects back to the C2 server, awaiting commands. The attacker can remotely send instructions to the infected system and by using multiple C2 frameworks, attackers can improve their chances of avoiding detection, allowing them to evaluate the security defenses of a target more thoroughly. Ultimately, they are designed to give operators the ability to perform post-exploitation tasks, maintain persistence, and collaborate with other operators to achieve their goals. They typically support external post-exploitation hacking tools as well, and have the ability to hide these tools in the memory of the targeted system. This means that they can be customized for the specific needs of a team/engagement.</p>
<p>C2 Frameworks can generally be divided into 3 parts:</p>
<ul>
<li><strong>C2 Server</strong>: The Command Center</li>
<li><strong>C2 Client</strong>: The Interface used by the Attacker</li>
<li><strong>C2 Agent</strong>: The Software Installed on the Compromised System to Facilitate Communication</li>
</ul>
<h3 id="c2-servers"><a class="header" href="#c2-servers">C2 Servers</a></h3>
<p>A <strong>C2 Server</strong> is the centralized hub where the attacker orchestrates their operation from. It is used for many purposes, from issuing commands for tasks like data theft, lateral movement, or deploying additional malware; to managing the connections to compromised systems. Attackers connect to it from their <strong>C2 Client</strong>, and ultimately it is responsible for facilitating the activities the attacker deems neccesary to complete their objective. C2 servers an be hosted in a few different ways:</p>
<ul>
<li><strong>Dedicated Infrastructure</strong>: Self-hosted servers or virtual-private servers (VPS).</li>
<li><strong>Cloud Server</strong>: Platforms like AWS or Azure are often used because they can blend in with normal traffic.</li>
<li><strong>Compromised Servers</strong>: Sometimes attackers hijack someone else's infrastructure to avoid being traced.</li>
</ul>
<p>Choose the option that meets the requirements of your engagement the best. At the end of the day, the C2 Server is important because it is a continuously running program that connects the various parts of the C2 Framework together. It plays an important role in monitoring the health of C2 Agents, providing resources and executing on commands for operators, and providing administrators with the tools needed to enforce policies and procedures. Good C2 Frameworks also keep logs of all activities, making it easy to audit engagements and write reports when they are complete.</p>
<p><img src="img/c2_server.png" alt="image" /></p>
<blockquote>
<p>The <strong>HAVOC</strong> C2 Teamserver Console</p>
</blockquote>
<p>Importantly, C2 Servers create <strong>listeners</strong>. These are network endpoints/services that wait for incoming connections from agents. They operate over various network protocols (i.e., <code>SMB</code>, <code>TCP</code>, <code>HTTP</code>, <code>DNS</code> etc.), and define how agents communicate with the C2 infrastructure and act as the entry point for establishing and maintaining C2 communication. They are responsible for:</p>
<ul>
<li>Receiving callbacks from agents</li>
<li>Negotiating communication parameters</li>
<li>Delivering payloads and tasks</li>
<li>Maintaining active sessions</li>
</ul>
<p>Typically, operators use the <strong>C2 Client</strong> to configure a listener, then the C2 Server stores and manages it. They are fundamental components of the C2 Infrastructure, as they act as the bridge between compromised endpoints and the rest of the attacker's control infrastructure. Without them, agents would have no method or location (IP Address, Port Number, Network Protocol, and Authentication Settings) to contact the C2 server.</p>
<h3 id="c2-clients"><a class="header" href="#c2-clients">C2 Clients</a></h3>
<p>The <strong>C2 Client</strong> is the interface where the attacker manages their operation. It provides a number of functions for the attacker, allowing them to:</p>
<ul>
<li><strong>Issue Commands</strong>: Tell the infected systems to collect files, execute tasks, or spread malware.</li>
<li><strong>Automate Tasks</strong>: Save time on repetitive ativities.</li>
<li><strong>Monitoor in Real TIme</strong>: Live updates on what is happening across compromised systems.</li>
<li><strong>Customize Attacks</strong>: Write scripts or add plugins to adapt to specific targets.</li>
</ul>
<p>Where the C2 Server is the engine that facilitates operations, the C2 Client is the dashboard that shares information with the operators about the state of the engagement, allows operators to configure payloads for target systems, and send commands to the C2 server to be executed on target systems. Essentially, the C2 Client is the console where each operator observes the state of the engagement and initiates their own contributions.</p>
<p><img src="img/c2_client.png" alt="image" /></p>
<blockquote>
<p>The <strong>HAVOC</strong> C2 Client</p>
</blockquote>
<h3 id="c2-agents"><a class="header" href="#c2-agents">C2 Agents</a></h3>
<p><strong>C2 Agents</strong> are small pieces of software installed on compromised systems that connect the infected device back to the C2 Server and carries out the attacker's commands. Once a system is infected, the agent calls back to the C2 server. This can happen through encrypted web traffic (i.e. <code>HTTPS</code>), DNS Tunneling, or other covert channels. The agent waits for instructions and then executes commands. They are designed to be stealthy. Often, they mimic legitimate processes (i.e., <code>svchost.exe</code>) or use fileless malware techniques to stay under the radar. Sometimes, they are referred to as <code>C2 Implants</code> or <code>bots</code> depending on the C2 framework you are using.</p>
<p><img src="img/c2_agent.png" alt="image" /></p>
<blockquote>
<p>The <strong>HAVOC</strong> <code>demon.x64.exe</code> C2 Agent Executing On a Target System</p>
</blockquote>
<h3 id="types-of-c2-frameworks"><a class="header" href="#types-of-c2-frameworks">Types of C2 Frameworks</a></h3>
<p>When it boils down to it, attackers use two types of C2 Framework: <strong>Custom-Built</strong> and <strong>Off-the-Shelf</strong>. Some examples of Custom-Built frameworks include:</p>
<ul>
<li><strong><a href="https://attack.mitre.org/software/S0054/">CloudDuke</a></strong> from <strong><a href="https://attack.mitre.org/groups/G0016/">APT29</a></strong></li>
<li><strong><a href="https://attack.mitre.org/software/S0502/">Drovorub</a></strong> from <strong><a href="https://attack.mitre.org/groups/G0007/">APT28</a></strong></li>
<li><strong><a href="https://attack.mitre.org/software/S1051/">Keyplug</a></strong> from <strong><a href="https://attack.mitre.org/software/S1051/">APT41</a></strong></li>
</ul>
<p>These are custom software designed by the attacker to manage a certain engagement or type of attack. Some examples of Off-the-Shelf frameworks include:</p>
<ul>
<li><a href="https://www.cobaltstrike.com">Cobalt Strike</a></li>
<li><a href="https://www.metasploit.com">Metasploit</a></li>
<li><a href="https://havocframework.com">Havoc</a></li>
<li><a href="https://bc-security.gitbook.io/empire-wiki">Empire</a></li>
<li><a href="https://sliver.sh">Sliver</a></li>
</ul>
<p>These are a mix of commercial and open-source products designed for right out of the box use by researchers, testers, and operators. Since they are publicly available, their default configurations likely produce known malicious signatures that security monitoring systems will be alerted to, so it is always important to know the tools you are using and how they will appear to the tools you are using.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p><strong>OPSEC</strong> Considerations:</p>
<p>Any good C2 Framework for Red Teaming will have an intuitive user interface, advanced automation capabilities, advanced encryption and authentication features, and extensive 3rd party integrations. But using a good product right out of the box is never enough to be truly stealthy during an engagement. When using C2 Frameworks, it is important to:</p>
<ul>
<li><strong>Disguise Communications</strong>: Make your traffic look normal. Since organizations rely on standard protocols like HTTP/HTTPS, DNS, and SMTP, blocking or flagging suspicious traffic risks disrupting legitimate operations.</li>
<li><strong>Obfuscate Activities</strong>: Use obfuscation techniques to cover your tracks. Some examples include:
<ul>
<li><strong>Domain Fronting</strong>: A technique where you route traffic through well-known services like content-delivery networks</li>
<li><strong>Impersonating legitimate protocols</strong></li>
<li><strong>Deploying polymorphic malware that constantly changes form</strong>
These techniques hinder signature-based detection tools, as they cannot keep up with constantly shifting patterns.</li>
</ul>
</li>
<li><strong>Mask Network Activity</strong>: Utilize redirectors or multi-stage C2 servers to act as a go-between, funneling traffic from compromised systems to the actual C2 server. This masks the origin of traffic, making it difficult to track the location of the attacker.</li>
</ul>
<p>This last point about redirectors is particularly important. Modern Red Teams rarely connect agents against their primary C2 Server (the <strong>Teamserver</strong>). Instead, they seperate the long-term control server from the agents with short-term, disposable ingress points. This is essentially wht <strong>redirectors</strong> are. They mask the true IP address of the C2 server, ensuring that if the blue team disovers and blocks the discovered IP, only the redirector is burned, and the core infrastructure remains healthy and undisturbed. There are essentially two types of redirector:</p>
<ul>
<li><strong>Dumb Redirectors</strong>: Simply forward all traffic on a specific port to the C2 Server using a service like <code>iptables</code> or <code>socat</code>.</li>
<li><strong>Smart Redirectors</strong>: Use web servers (i.e., <code>Apache</code> or <code>Nginx</code>) to process incoming HTTP/S traffic so that only verified, filtered traffic can make it back to the C2 server.</li>
</ul>
<p>We will review Red Team OPSEC in more detail later in this chapter.</p>
</div>
</div>
<h2 id="c2-frameworks-in-action"><a class="header" href="#c2-frameworks-in-action">C2 Frameworks in Action</a></h2>
<p>Agents are frequently deployed via <strong>payloads</strong>, specialized code segments engineered for particular actions on the target, such as establishing remote shells, installing backdoors, harvesting credentials, or deploying additional malicious modules. Payloads can be staged or stageless. A <strong>staged</strong> payload is broken up into parts: the <strong>stager</strong> and the <strong>stages</strong>. The <strong>stager</strong> is a small, first-stage payload used to establish initial access to a target system, then retrieve the next component of the payload. <strong>Stages</strong> comprise additional components of the payload that serve different purposes. For instance, a <strong>dropper</strong> is a payload component that installs some other, malicious program onto the system (such as a virus, ransomware, a backdoor, etc.). Additional components may either be packaged with the dropper or installed over the internet. <strong>Loaders</strong> place a malicious payload component into memory so that it may be executed. Typically they are used to evade disk-based detection mechanisms, as executable components are either decrypted or installed directly into memory, without ever touching the hard drive. Other staged components can be used to accomplish specific tasks, such as <strong>injectors</strong>, <strong>decryptors</strong>, and <strong>environment checkers</strong>, but ultimately each stage is geared toward installing the agent on the target system to establish a communication channel with the C2 Server. <strong>Stageless</strong> payloads contain everything they need to run the agent in a single delivery. No additional downloads are required after for execution.</p>
<p>Once an agent is installed and executed on the target system, it sends a <strong>callback</strong> to the C2 Server, creating a session identifier and establishing trust between the server and the agent. After sending the initial callback, most agents will switch to <strong>beaconing</strong> mode. Essentially, a <strong>beacon</strong> is a periodic outbound message sent by the agent to the C2 server, that typically signals that the agent is alive, requests new <strong>tasking</strong>, and sends queued results/metadata back to the C2 server.</p>
<blockquote>
<p><strong>Tasking</strong> describes the mechanism by which a C2 server issues instructions to an agent, and the agent executes those instructions and returns the results. In many frameworks, a <strong>task</strong> is the instruction itself, whereas a <strong>job</strong> is the execution instance of that task on the agent.
A <strong>heartbeat</strong> is a specialized form of beacon, which simply confirms that the agent is still running on the target. It contains minimal or no data, and is often used when no tasks are queued. In many frameworks, every beacon implicitly acts as a heartbeat. Heartbeats help operators distinguish between dormant but healthy agents and disconnected or terminated agents.</p>
</blockquote>
<p><strong>Jitter</strong> introduces random variation into beacon or heartbeat timing. Instead of beaconing over an exact interval (i.e., every <code>60</code> seconds), jitter modifies the delay so that it is more random (i.e., <code>60</code> seconds Â± <code>20%</code>). Jitter is important because fixed intervals are very easy to detect. Jitter makes traffic appear more human or application-like, making C2 operations more difficult to detect.</p>
<p>Advanced frameworks (like <strong>Cobalt Strike</strong>) implement <strong>Malleable Profiles</strong>, which allow operators to customimze how the C2 traffic appears on the network, granting them the ability to make it appear more like normal network traffic and evade detection. These are small programs that define provide a template describing C2 beacon should look. For instance, here is an example of a Malleable C2 Profile designed to disguise beacon traffic as <code>GMail</code> traffic on a network. It was published by <strong>BC-Security</strong>, a group of cybersecurity engineers and offensive security enthusiasts that actively maintain and update Powershell Empire in their spare time ;-). Credit to <code>@ChrisTruncer</code> for authoring this profile:</p>
<pre><code># Make requests look like GMail web requests
#
# Author: @ChrisTruncer

https-certificate {
	set CN       "gmail.com";
	set O        "Google GMail";
	set C        "US";
	set L        "Mountain View";
	set OU       "Google Mail";
	set ST       "CA";
	set validity "365";
}

set sleeptime "60000";
set pipename "interprocess_##";
set spawnto "userinit.exe";
set jitter "15";
set dns_idle "8.8.4.4";

http-get {
	set uri "/_/scs/mail-static/_/js/";
	client {

		metadata {
			base64;
			prepend "OSID=";
			header "Cookie";
		}

		header "Accept" "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";
		header "Accept-Language" "en-US,en;q=0.5";
		header "Accept-Encoding" "gzip, deflate";
		header "DNT" "1";
	}

	server {
		header "X-Content-Type-Options" "nosniff";
		header "X-Frame-Options" "SAMEORIGIN";
		header "Cache-Control" "public, max-age=31536000";
		header "X-XSS-Protection" "1; mode=block";
		header "Server" "GSE";
		header "Alternate-Protocol" "443:quic,p=1";

		output{
			prepend "try(";
			prepend "O(L.Oa(),\"sy580\")";
			prepend "N(L.Oa(),\"sy580\");P(L.Oa(),\"sy580\");";
			prepend ")catch(e)(_DumpException(e))";
			prepend "try(";
			prepend "O(L.Oa(),\"sy558\");";
			prepend "N(L.Oa(),\"sy558\");P(L.Oa(),\"sy558\");";
			prepend ")catch(e)(_DumpException(e))";
			prepend "try(";

			append "var f2=function(a)(a=a.wa;return\"application/chromium-bookmark-folder\"==a||\"application/chromium-root-folder\"==a||\"application/vnd.google-apps.folder\"==a||\"application/vnd.google-apps.photoalbum\"==a||\"application/vnd.google-apps.rollupphotoalbum\"==a)";
			append ",g2=function(a)(return a.ra),s8d=function(a)(return a?hb(a,function(a)(return new UP(a)):[]),h2=function(a)(switch(a)(case \"all\":case \"docs-images\":case \"docs-images-and-videos\":case \"docs-videos\":case \"documents\":case \"drawings\":case \"folders\":case \"forms\":case \"pdfs\":case \"presentations\":case \"sites\":case \"spreadsheets\":case \"tables\":return!0)return!1); O(L.Oa(),\"sy588\")";

			print;

		}
	}
}

http-post {
	set uri "/mail/u/0/";
	client {
		parameter "ui" "d3244c4707";
		parameter "hop" "6928632";
		parameter "start" "0";
		header "Content-Type" "application/x-www-form-urlencoded;charset=utf-8";

		id {
			base64;
			prepend "OSID=";
			header "Cookie";
        }

		output{
			base64;
			print;
		}
	}

	server {
		header "X-Content-Type-Options" "nosniff";
		header "X-Frame-Options" "SAMEORIGIN";
		header "Cache-Control" "no-cache, no-store, max-age=0, must-revalidate";
		header "X-XSS-Protection" "1; mode=block";
		header "Server" "GSE";

		output {

			prepend "[[[\"apm\",\"";

			append "\"]";
			append ",[\"ci\",[]";
			append "]";
			append ",[\"cm\",[]";
			append ",[]";
			append "]";
			append "],'dbb8796a80d45e1f']";

			print;
		}

	}
}
</code></pre>
<blockquote>
<p>Source: <a href="https://github.com/BC-SECURITY/Malleable-C2-Profiles/blob/master/Normal/reddit.profile">BC-Security GitHub</a></p>
</blockquote>
<!--
Breakdown how what this Malleable Profile is doing
Show how Malleable Profile traffic appears on the network using Wireshark
-->
<p>A description of the syntax of the Malleable C2 Profile language can be found <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_profile-language.htm?__hstc=173638140.5572de669d16511e7a7369de9b5a24a7.1769794321624.1769794321624.1769797138410.2&amp;__hssc=173638140.2.1769797138410&amp;__hsfp=d4fbe0704d25aa0908150659cafc510a&amp;_gl=1*1s3xxag*_gcl_au*NjI1OTE0NjQ1LjE3Njk3OTQzMTU.*_ga*MTA0ODgwNTE1OC4xNzY5Nzk0MzE3*_ga_HNS2ZVG55R*czE3Njk3OTcxMzMkbzIkZzEkdDE3Njk3OTcxNTEkajQyJGwwJGgw#_Toc65482837">here</a>.</p>
<p>C2 Frameworks are important because they offer a continuous, secure, and manageable connection between the attacker and their targeted systems. We will review this subject in more technical depth in the chapters that follow.</p>
<h2 id="operations-security"><a class="header" href="#operations-security">Operations Security</a></h2>
<p><strong>Operations Security</strong> (OpSec) is a process that identifies critical information to determine if friently actions can be observed by enemy intelligence, determines if information obtained by adversaries could be interpreted to be useful to them, and executes selected measures that eliminate or reduce adversary exploitation of friendly critical information. It is a term derived from the United States Military, stemming back to the Vietnam War Operation, Codename:<strong><a href="https://www.nsa.gov/portals/75/documents/news-features/declassified-documents/cryptologic-histories/purple_dragon.pdf">Purple Dragon</a></strong>, that was later adopted by the intelligence and security communities. As it relates to red teams, they do not want the blue team to "connect the dots". Each time the red team interacts with their target organization, it leaves behind a "dot". With enough dots, the blue team can identify red team tools and infrastrucutre, then prevent or mitigate attacks after they are fully realized. This can be especially frustrating if the blue team connects the dots before the red team knows it. The red team can keep the blue team from connecting the dots by either not leaving any, or only leaving dots that are not associated with one another.</p>
<div id="admonition-basic-red-team-opsec-checklist" class="admonition admonish-warning" role="note" aria-labelledby="admonition-basic-red-team-opsec-checklist-title">
<div class="admonition-title">
<div id="admonition-basic-red-team-opsec-checklist-title">
<p>Basic Red Team OpSec Checklist</p>
</div>
<a class="admonition-anchor-link" href="#admonition-basic-red-team-opsec-checklist"></a>
</div>
<div>
<p>As an attacker, <strong>be wary of revealing the following information</strong> during an attack:</p>
<ul>
<li>Hostname</li>
<li>Domain Name
<ul>
<li>Avoid typosquating the target domain</li>
<li>Use WHOIS privacy</li>
<li>Use one domain for every red team act</li>
</ul>
</li>
<li>Browser User-Agent</li>
<li>Access to payload URLs and Landing Pages</li>
<li>Source IP Addresses
<ul>
<li>Never use the same IP address for two activities that you don't want assocaited with each other</li>
<li>IP addresses should make sense relative to your actions from the IP</li>
<li>When logging into user accounts:
<ul>
<li>Use one IP address per user account and keep using the same IP for all subsequent logins</li>
<li>Login from an IP address in the same region as the user</li>
<li>Login from a service provider that makes sense for the target user.</li>
<li>Avoid known-suspicious IPs: TOR, Proxies, etc.</li>
</ul>
</li>
<li>Get new source IP addresses from:
<ul>
<li>Residential IP address Providers:
<ul>
<li>Luminati (Now Bright Data)</li>
<li>Smartproxy</li>
</ul>
</li>
<li>IP Address Rotation Services:
<ul>
<li>GeoSurf</li>
<li>Oxylabs</li>
</ul>
</li>
<li>Mobile hotspots</li>
<li>Wifi hotspots</li>
<li>VPNs (free or paid)</li>
<li>Cloud Service Providers</li>
<li>TOR (when required)</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Inspect each source IP for "tells" and build your own vetted list</p>
</blockquote>
<ul>
<li>Third-party services
<ul>
<li>Assess whether red team actions are likely to violate TOS
<ul>
<li>Modify identity (name, email, billing address, phone), credit card numbers, and source IP for repeat sign-ups</li>
</ul>
</li>
<li>Assess whether your registration information is likely to be exposed</li>
<li>Assess whether use of the same account across multiple projects is likely to leak information about the red team or its customers
<ul>
<li>Can the resource owner be identified by outsiders?</li>
<li>Can relationships between multiple resources be assocaited with each other?</li>
<li>Is there a reasonable level of trust with the resource provider?</li>
</ul>
</li>
<li><strong>SSL/TLS</strong> certificates and CAs
<ul>
<li>Watch out for data leaks in certificate transparency logs
<ul>
<li>Customer names</li>
<li>Email Addresses</li>
<li>Phone Numbers</li>
</ul>
</li>
<li>No default or self-signed certificates. Both can easily be flagged or blocked by Censys.io search</li>
<li><strong>Let's Encrypt</strong> certificates may be suspicious, as they are the default CA in lots of hacking tutorials, though they are used by legitimate services as well.</li>
</ul>
<blockquote>
<p><strong>Let's Encrypt Certificates</strong>: Digital certificates provided by the non-profit Certificate Authority (CA) <strong>Let's Encrypt</strong>, who offer SSL/TLS certificates at no cost, making secure connections accessible to a wider range of users and organizations. These certificates have a validity period of 90 days.</p>
</blockquote>
</li>
<li>Network Services
<ul>
<li>Don't expose services to the internet that aren't required
<ul>
<li>Use SSH port forwarding for acceess from the red team</li>
</ul>
</li>
<li>Change all default settings on hacking tools that listen on an Internet-facing port</li>
<li>Use redirectors liberally and spread them across multiple CSPs</li>
<li>Use Common web services (Apache, Nginx) to redirect HTTP/S traffic to servers run by hacking tools</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Know the tools that you are using</p>
<ul>
<li>Confirm that the <strong>tool isn't harming you</strong></li>
<li>Confirm that <strong>how the tool/attack looks</strong> from the defenders perspective <strong>isn't suspicious</strong></li>
<li>Confirm that the <strong>attack looks believable</strong> from the perspective of the target user.</li>
</ul>
</blockquote>
</div>
</div>
<p>Ultimately, the goal with OpSec is to reduce mission compromise by identifying and elminimating unintentional data leaks through behavior, communications, or logistics. Many red teams fail to maintain strict OpSec because of reliance on pre-configured tools, careless infrastructure setups, or insufficient separation of operational identities. Some consequences include:</p>
<ul>
<li>Burned C2 Infrastruture (IP/Domain Blacklisting)</li>
<li>Attribution of activity to consulting firms or internal threat emulation teams</li>
<li>Legal complications in regulated industries if internal users are affected</li>
</ul>
<p>Some notable cases include:</p>
<ul>
<li>APT28 (FancyBear): In late May of 2018, the U.S. Department of Justice announced the high-profile disruption of APT28's VPNFilter Infrastructure. This was due to:
<ul>
<li>Shared Registrant and Certificate Metadata</li>
<li>Reuse of Hosting Providers</li>
<li>Public Access to C2 Domain Infrastructure through DNS</li>
<li>Poorly Routed Malware Callbacks</li>
</ul>
</li>
<li>Public reports (i.e., <a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa24-326a?utm_source=chatgpt.com">CISA</a>, <a href="https://networkdigitalsecurity.com/case-studies/case-study-red-team-engagement-for-a-government-facility/?utm_source=chatgpt.com">NDS, Inc.</a>) show clients identifying Red Team prematurely due to:
<ul>
<li>Reused Beacon Patterns</li>
<li>Leaked Usernames</li>
<li>C2 Reuse</li>
<li>Suspicious Protocol Use (i.e., constant packet length, Base64 blobs in parameters)</li>
</ul>
</li>
</ul>
<p>Red Teams must treat every engagement as a live adversarial environment. Even if the target is known to be passive or "simulated", every artifact left behind is subject to future review, correlation, or forensic discovery.</p>
<h2 id="the-five-step-opsec-process"><a class="header" href="#the-five-step-opsec-process">The Five-Step OpSec Process</a></h2>
<p>The formal OpSec process, standardized by the <a href="https://media.defense.gov/2020/Oct/28/2002524943/-1/-1/0/NTTP-3-13.3M-MCTP-3-32B-OPSEC-2017.PDF?utm_source=chatgpt.com">U.S. Department of Defense</a> consists of five iterative steps. While originally developed for military use, the same structure appleis to offensive cyber operations. Understanding an applying this process reduces the risk of operational exposure due to leaks in infrastructure, behavior, or tooling.</p>
<h3 id="step-1-identify-critical-information"><a class="header" href="#step-1-identify-critical-information">Step 1: Identify Critical Information</a></h3>
<p>Identify what must be protected. In the context of Red Teaming, critical information includes:</p>
<ul>
<li>IP Address ranges of infrastructure (C2, redirectors, stagers)</li>
<li>Beaconing patterns, headers, or payload signatures</li>
<li>Operator metadata (usernames, email headers, browser fingerprints)</li>
<li>Domain registration data</li>
<li>TTPs that can be fingerprinted</li>
</ul>
<p>Focus on what could provide adversaries with actionable intelligence if discovered. Document all operational assets, personas, and artifacts before deployment. Treat metadata as data.</p>
<h3 id="step-2-analyze-threats"><a class="header" href="#step-2-analyze-threats">Step 2: Analyze Threats</a></h3>
<p>Assess who might be observing or analyzing your activity and what their capabilities are. The interesting thing here is that you need to take advantage of any vulnerabilities in their Operations Security. Red Team operators should map the detection surface against potential observers, being:</p>
<ul>
<li>Internal Blue Team with Behavioral Detection</li>
<li>SIEMs Aggregating Logs Across Endpoints and Networks</li>
<li>Threat Intelligence Platforms Correlating Passive DNS, TLS Certificates or ASN data</li>
<li>External Scanners like Shodan, Censys, and Zoomeye</li>
</ul>
<p>Also, consider that threats may not always be your target. Aside from external TI platforms and external scanners, consider that:</p>
<ul>
<li>A unauthorized person trying to obtain mission critical information</li>
<li>A person who intentionally or unintentionally supplies mission critical information to an adversary</li>
<li>A public post detailing mission critical information</li>
<li>A person who shoulder-surfs
should all be considered threats as well. Question who has visibility into your infrastructure. Can DNS or IP behavior trigger alerts and do reused payloads match known malware signatures?</li>
</ul>
<h3 id="step-3-vulnerability-analysis"><a class="header" href="#step-3-vulnerability-analysis">Step 3: Vulnerability Analysis</a></h3>
<p>After identifying critical data and adversaries, analyze how this information could leak. This often includes:</p>
<ul>
<li>Misconfigured DNS (i.e., wildcard records exposing all subdomains)</li>
<li>Use of commercial VPN IPs instead of private infrastructure</li>
<li>DNS resolutions during payload testing (sandbox leaks)</li>
<li>Unencrypted communication during staging</li>
<li>Beacon jitter or frequency that follow default settings</li>
</ul>
<p>Audit your tools, infrastructure, and operator habits. Be able to answer the following question:</p>
<ol>
<li>What critical information indicators (friendly actions and open-source intelligence) will the planned operation generate through friendly activities?</li>
<li>What indicators can the target actually observe/collect?</li>
<li>What indicators can the target use to the disadvantage of friendly forces?</li>
</ol>
<p>Base on your answer to these questions, rank the criticality of each identified vulnerability.</p>
<h3 id="step-4-risk-assessment"><a class="header" href="#step-4-risk-assessment">Step 4: Risk Assessment</a></h3>
<p>Risk assessments estimate an adversary's capability to exploit a vulnerability and the potential effects such exploitation has on operations. During this step, you need to calculate the likelihood and impact of each identified vulnerability. Consider:</p>
<ul>
<li>What is the likelihood that the Blue Team detects our domain/IP via passive monitoring?</li>
<li>What is the impact if our infrastructure is blacklisted mid-engagement?</li>
<li>How easily can our TTPs be attributed to a known framework?</li>
</ul>
<p>Performing thorough risk assessments help red teams avoid unnecessary risks and accept necessary risks when the cost of mitigation outweights the benefit. Understand your security posture before you take any potentially alertable actions. For instance, using a default Cobalt Strike malleable profile or reusing open-source implants increases detection probability due to signature matching, therefore you should modify the configuration of your tools before using them to avoid quick and easy detection.</p>
<h3 id="step-5-apply-countermeasures"><a class="header" href="#step-5-apply-countermeasures">Step 5: Apply Countermeasures</a></h3>
<p>Applying OpSec principles and using countermeasures preserves the operation by preventing the target from discovering you or completely removing you from their systems after discovery. Once vulnerabilities are prioritized, apply technical and procedural controls. Counter measures may include:</p>
<ul>
<li>CDN Masking</li>
<li>IP Rotation</li>
<li>Use of custom payloads with obfuscated indicators</li>
<li>Payload testing in sandboxed environments</li>
<li>TLS certificate spoofing</li>
<li>Isolated, single-use domains and redirectors</li>
<li>Domain Fronting</li>
</ul>
<p>Countermeasures should be measurable for performance and effectiveness. It is best practice to automate infrastructure deployment usinc Infrastructure as Code (IaC) templates with OpSec constrains built-in.</p>
<h2 id="using-opsec-with-c2-frameworks"><a class="header" href="#using-opsec-with-c2-frameworks">Using OpSec with C2 Frameworks</a></h2>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Evasion.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="Reversing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Evasion.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="Reversing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
