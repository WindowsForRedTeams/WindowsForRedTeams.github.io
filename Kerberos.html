<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Appendix C: A Primer on Kerberos - The Red Teamers Bible</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/mdbook-admonish.css">
        <link rel="stylesheet" href="src/custom.css">
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Red Teamers Bible</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="appendix-c-a-primer-on-kerberos"><a class="header" href="#appendix-c-a-primer-on-kerberos">Appendix C: A Primer on Kerberos</a></h1>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How it Works</a></h2>
<p><strong>Kerberos</strong> replaces the <strong>New Technology LAN Manager</strong> (<code>NTLM</code>) as the default domain authentication protocol since Windows 2000. It works on a system of <strong>ticets</strong>, where principals (users and computers) are authenticated by a central, trusted server, granting them access to services without needing to provide their password over and over again. Kerberos doesn't require that end services know the principal's password. It assumes that there is no transport encryption on the network and that packets can be read/modified/replayed. Therefore, it relies on shared-secret cryptography to establish a trust relationship with clients.</p>
<p>The <strong>Key Distribution Center</strong> (<code>KDC</code>) is the trusted source for kerberos authentication that consists of three sub components:</p>
<ul>
<li>A database of all principals and their associated secrets (i.e., password hashed)</li>
<li>An <strong>Authentication Server</strong> (<code>AS</code>)</li>
<li>A <strong>Ticket Granting Server</strong> (<code>TGS</code>)</li>
</ul>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p>In a Windows domain, it's the domain controllers that act as the KDC, as every principal and their password hashes are stored in <strong>Active Directory</strong>.</p>
</div>
</div>
<p>A <strong>Ticket Granting Ticket</strong> (<code>TGT</code>) is provided to a principal after their identity has been verified by the <code>AS</code>. It is used in lieu of a principal having to provide their password every time they want to use a service. Each service can be identified by a forest unique <strong>Service Principal Name</strong> (<code>SPN</code>), which should be in the following format:</p>
<pre><code class="language-C">&lt;service class&gt;/&lt;host&gt;:&lt;port&gt;/&lt;service name&gt;
</code></pre>
<p>The <strong><service class></strong> describes the general type of the service. For instance, whether it is a <code>SqlServer</code>, <code>www</code> for a web server, or <code>ldap</code> for a <strong>Lightweight Database Access Protocol</strong> server. The <strong><host>:<port></strong> is simply the <strong>FQDNS</strong> or <strong>NetBios</strong> name, followed by the port that the server is running on. Finally, the <strong><service name></strong> is an optional distinguished name, objectGUID, or DNS Name that helps to further distinguish a service within a domain/forest. It can be ommitted for host-based services.</p>
<p>A <strong>service ticket</strong> is a component returned from the <strong>TGS</strong> in response to a request to access a service using kerberos authentication. A TGT is sent to the KDC as evidence that their identity has been verified.</p>
<p>A <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/21181737-74fd-492c-bfbd-0322993a9061"><strong>Privileged Attribute Certificate</strong></a> is a structure that can be attached to a ticket, which contains additional information about a principal. When a ticket is issued from a Windows Domain Controller, it will populate the <strong>PAC</strong> with information about the principal from Active Directory. This can include their:</p>
<ul>
<li><strong>Resource ID</strong> (<code>RID</code>)</li>
<li><strong>Domain Group Membership</strong></li>
<li><strong>User Account Control</strong> Information</li>
</ul>
<p>When presenting a service ticket to a service, the service is able to inspect the PAC to determine the user's privileges without having to query it from AD.</p>
<p><img src="img/kerberos.png" alt="image" /></p>
<blockquote>
<p><strong>Kerberos Authentication</strong> Overview</p>
</blockquote>
<p>Basically, Kerberos Authentication can be broken up into 3 phases:</p>
<h3 id="phase-1-authentication"><a class="header" href="#phase-1-authentication">Phase 1: Authentication</a></h3>
<ol>
<li>
<p><strong>AS-REQ</strong> (Authentication Service Request)
The Client sends a message to the KDC saying, "I am User X, and I want to log in." This request is partially encrypted using a hash of the user's password.</p>
</li>
<li>
<p><strong>AS-REP</strong> (Authentication Service Response)
The KDC verifies the user's identity. If successful, it sends back a TGT. The TGT is encrypted with the KDC's own secret key (so the client cannot tamper with it). The client now has proof of identity that it can use for the rest of the session.</p>
</li>
</ol>
<h3 id="phase-2-authorization"><a class="header" href="#phase-2-authorization">Phase 2: Authorization</a></h3>
<ol start="3">
<li>
<p><strong>TGS-REQ</strong> (Ticket Granting Service Request)
At this point, the Client wants to access a specific Service. It sends the TGT back to the KDC, authenticating itself and requesting access to that specific Service.</p>
</li>
<li>
<p><strong>TGS-REP</strong> (Ticket Granting Service Response)
The KDC validates the TGT. If valid, it issues a Service Ticket. This ticket is encrypted using the Service's secret key. The Client cannot read it, but the Service will be able to.</p>
</li>
</ol>
<h3 id="phase-3-service-access"><a class="header" href="#phase-3-service-access">Phase 3: Service Access</a></h3>
<ol start="5">
<li><strong>AP-REQ</strong> (Application Request)
The client sends the Service Ticket to the Service to request access. The Service decrypts the ticket using its own secret key to verify the user's identity.</li>
</ol>
<p>5.5 <strong>Optional PAC Validation</strong>
The Service asks the KDC to verify the PAC in order to ensure it's authenticity and prevent privilege escalation attacks using forged PAC.</p>
<ol start="6">
<li><strong>AP-REP</strong> (Application Response)
The Service confirms the connection to the Client. This completes the Mutual Authentication. The Client knows the Service is real, and the Service knows the Client is real, establishing the connection.</li>
</ol>
<h2 id="delegation"><a class="header" href="#delegation">Delegation</a></h2>
<p>Sometimes, services need to act on behalf or a user to interact with other back end resources. <strong>Delegation</strong> describes the method used to facilitate this type of interaction. There are two types. When <strong>Unconstrained Delegation</strong> is implemented, the server receives the ticket, extracts the user's TGT, and caches it in its memory (<code>LSASS</code>). The server can now use that TGT to impersonate the user to any service on the network. If an attacker compromises a server with Unconstrained Delegation, they can dump the memory to steal the TGTs of any administrator who connects to it (i.e., a Domain Admin performs maintenance on the box -&gt; Attacker steads DA TGT -&gt; Attacker owns the domain). This is considered highly insecure today.
The more secure method, <strong>Constrained Delegation</strong>, was introduced in Windows Server 2003 to fix the security risks of Unconstrained Delegation. The service is strictly limited in where it can send the user's credentials. The Domain Admin specifies exactly which SPNs the middle-tier server is allowed to access on behalf of the user.</p>
<p>When a user authenticates to a service with <strong>Constrained Delegation</strong> enabled, the user gets a Kerberos TGT and the Service receives a forwardable ticket. With this, the service can request service tickets from allowed SPNs.</p>
<p>Services with Constrained Delegation enabled can implements additional extensions. For instance, <strong>S4U2Self</strong> (<code>Service-for-User-to-Self</code>) allows the configured service to ask for a ticket to itself on behalf of the client, even if the user did not authenticate using Kerberos. Essentially, this allows services to grant trusted users access to to themselves by performing a <strong>Protocol Transition</strong>, converting a non Kerberos authentication into a valid Kerberos ticket. Another example is <strong>S4U2Proxy</strong>, which allows the service to use a <code>S4U2Self</code> ticket to access another service as the user. On services with <strong>Constrained Delegation</strong> enabled, the KDC will verify whether the <code>S4U2Proxy</code> service is allowed to delegate users to the requested service and whether the provided ticket is authentic. If it is, a new ticket is granted allowing the original service to act as a proxy for the authenticated user on the secondary service.</p>
<h2 id="attacking-kerberos"><a class="header" href="#attacking-kerberos">Attacking Kerberos</a></h2>
<p>Attackers may attempt to exploit Kerberos to impersonate legitimate users within a domain. Here, we will review a few of those techniques and if possible, how they are mitigated.</p>
<h3 id="silver-tickets"><a class="header" href="#silver-tickets">Silver Tickets</a></h3>
<p>A <strong>Silver Ticket</strong> is a forged <strong>Service Ticket</strong>. This allows an attacker to authenticate directly to a given service, without authenticating with the *<em>Domain Controller</em></p>
<h2 id="additional-resources"><a class="header" href="#additional-resources">Additional Resources</a></h2>
<p>More information about <strong>Kerberos</strong> can be found <a href="https://learn.microsoft.com/en-us/windows/win32/ad/mutual-authentication-using-kerberos">here</a>.
To Learn more about <strong>Delegation</strong>, visit this link <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94">here</a>.
You can find thread intelligence on attacking kerberos, visit the following links on Mitre:</p>
<ul>
<li><a href="https://attack.mitre.org/techniques/T1558/002/">Silver Tickets</a></li>
<li><a href="https://attack.mitre.org/techniques/T1558/001/">Golden Tickets</a></li>
<li><a href="https://attack.mitre.org/techniques/T1558/003/">Kerberoasting</a></li>
</ul>
<p>More information on Diamond and Sapphire Tickets can be found <a href="https://unit42.paloaltonetworks.com/next-gen-kerberos-attacks/">here</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="Shellcode.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="Reversing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="Shellcode.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="Reversing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
